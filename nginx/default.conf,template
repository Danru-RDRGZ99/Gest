# ⬇️ NO pongas 'map' ni nada fuera del server; este archivo es un vhost.
server {
  listen 80 default_server;
  listen [::]:80 default_server;

  # Health
  location = /__health {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Ajustes proxy comunes
  set $proxy_timeouts "ok"; # marcador
  proxy_http_version 1.1;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Connection        "";

  proxy_connect_timeout   10s;
  proxy_send_timeout      60s;
  proxy_read_timeout      60s;

  # ========= USUARIOS =========
  set $USUARIOS $USUARIOS_PUBLIC; # ej: servicio-usuarios-xxxx.up.railway.app

  location = /captcha {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $USUARIOS;
    proxy_set_header Host $USUARIOS;
    proxy_pass https://$USUARIOS$request_uri;
  }

  location = /token {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $USUARIOS;
    proxy_set_header Host $USUARIOS;
    proxy_pass https://$USUARIOS$request_uri;
  }

  location = /register {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $USUARIOS;
    proxy_set_header Host $USUARIOS;
    proxy_pass https://$USUARIOS$request_uri;
  }

  location ^~ /usuarios/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $USUARIOS;
    proxy_set_header Host $USUARIOS;
    proxy_pass https://$USUARIOS$request_uri;
  }

  location = /usuarios {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $USUARIOS;
    proxy_set_header Host $USUARIOS;
    proxy_pass https://$USUARIOS$request_uri;
  }

  # ========= RESERVAS =========
  set $RESERVAS $RESERVAS_PUBLIC; # ej: servicio-reservas-xxxx.up.railway.app

  location ^~ /reservas/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $RESERVAS;
    proxy_set_header Host $RESERVAS;
    proxy_pass https://$RESERVAS$request_uri;
  }

  location = /reservas {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $RESERVAS;
    proxy_set_header Host $RESERVAS;
    proxy_pass https://$RESERVAS$request_uri;
  }

  # ========= INVENTARIO =========
  set $INVENTARIO $INVENTARIO_PUBLIC; # ej: servicio-inventario-xxxx.up.railway.app

  location ^~ /prestamos/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location = /prestamos {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location ^~ /admin/prestamos/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location = /admin/prestamos {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location ^~ /planteles/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location = /planteles {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location ^~ /laboratorios/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location = /laboratorios {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location ^~ /recursos/ {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }

  location = /recursos {
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=30s;
    proxy_ssl_server_name on;
    proxy_ssl_name $INVENTARIO;
    proxy_set_header Host $INVENTARIO;
    proxy_pass https://$INVENTARIO$request_uri;
  }
}

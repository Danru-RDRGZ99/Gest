# =========================
# nginx/default.conf.template
# Opción B: proxy a dominios públicos (HTTPS) con SNI
# =========================

server {
  listen 80 default_server;
  listen [::]:80 default_server;

  # --------- Debug/health ----------
  location = /__health {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }
  # (Opcional) endpoint para ver que envsubst sí reemplazó las variables
  location = /__vars {
    add_header Content-Type text/plain;
    return 200 "USUARIOS_PUBLIC=${USUARIOS_PUBLIC}\nRESERVAS_PUBLIC=${RESERVAS_PUBLIC}\nINVENTARIO_PUBLIC=${INVENTARIO_PUBLIC}\n";
  }

  # --------- DNS + TLS a upstream públicos ----------
  # Usamos resolvers públicos para evitar el 127.0.0.11 que te fallaba
  resolver 1.1.1.1 8.8.8.8 valid=60s;
  resolver_timeout 5s;

  proxy_ssl_server_name on;        # SNI correcto
  proxy_http_version 1.1;
  proxy_set_header Connection "";  # permite keep-alive
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # --------- USUARIOS ----------
  # NOTA: Como vamos a hostnames públicos, hay que enviar Host del upstream
  set $usuarios_host ${USUARIOS_PUBLIC};

  location = /captcha {
    proxy_set_header Host $usuarios_host;
    proxy_pass https://$usuarios_host/captcha;
  }

  location = /token {
    proxy_set_header Host $usuarios_host;
    proxy_pass https://$usuarios_host/token;
  }

  location = /register {
    proxy_set_header Host $usuarios_host;
    proxy_pass https://$usuarios_host/register;
  }

  location ^~ /usuarios/ {
    proxy_set_header Host $usuarios_host;
    proxy_pass https://$usuarios_host;
  }

  location = /usuarios {
    proxy_set_header Host $usuarios_host;
    proxy_pass https://$usuarios_host/usuarios;
  }

  # --------- RESERVAS ----------
  set $reservas_host ${RESERVAS_PUBLIC};

  location ^~ /reservas/ {
    proxy_set_header Host $reservas_host;
    proxy_pass https://$reservas_host;
  }

  location = /reservas {
    proxy_set_header Host $reservas_host;
    proxy_pass https://$reservas_host/reservas;
  }

  # --------- INVENTARIO ----------
  set $inventario_host ${INVENTARIO_PUBLIC};

  location ^~ /prestamos/ {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host;
  }

  location = /prestamos {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host/prestamos;
  }

  location ^~ /admin/prestamos/ {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host;
  }

  location = /admin/prestamos {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host/admin/prestamos;
  }

  location ^~ /planteles/ {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host;
  }

  location = /planteles {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host/planteles;
  }

  location ^~ /laboratorios/ {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host;
  }

  location = /laboratorios {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host/laboratorios;
  }

  location ^~ /recursos/ {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host;
  }

  location = /recursos {
    proxy_set_header Host $inventario_host;
    proxy_pass https://$inventario_host/recursos;
  }
}
